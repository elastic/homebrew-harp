# typed: false
# frozen_string_literal: true

# Code generated by Harp build tool
class Harp < Formula
  desc "Secret management toolchain"
  homepage "https://github.com/elastic/harp"
  license "Apache-2.0"
  stable do
    on_macos do
      if Hardware::CPU.intel?
        url "https://github.com/elastic/harp/releases/download/cmd%2Fharp%2Fv0.2.0/harp-darwin-amd64-v0.2.0.tar.xz"
        sha256 "d9759520464c1412ce33c2b8f2f45b8e583f6df6a92a1848a669e960e50bc403"
      elsif Hardware::CPU.arm?
        url "https://github.com/elastic/harp/releases/download/cmd%2Fharp%2Fv0.2.0/harp-darwin-arm64-v0.2.0.tar.xz"
        sha256 "05f8e0d6ad148eb4fb1082422282caed54396610e0caf9a741ef03053fba5bdc"
      end
    end
    on_linux do
      if Hardware::CPU.intel?
        if Hardware::CPU.is_64_bit?
          url "https://github.com/elastic/harp/releases/download/cmd%2Fharp%2Fv0.2.0/harp-linux-amd64-v0.2.0.tar.xz"
          sha256 "4301ee1c4663576417d3dc5e332f5666fef0d146828b2ceb382aba3006fe8360"
        end
      elsif Hardware::CPU.arm?
        if Hardware::CPU.is_64_bit?
          url "https://github.com/elastic/harp/releases/download/cmd%2Fharp%2Fv0.2.0/harp-linux-arm64-v0.2.0.tar.xz"
          sha256 "415f1385d5cc222109b951375545c6f4b05e1e4705f5e9a07bda048effae9415"
        else
          url "https://github.com/elastic/harp/releases/download/cmd%2Fharp%2Fv0.2.0/harp-linux-arm7-v0.2.0.tar.xz"
          sha256 "2e3a7c3b3cf12b39eef5da9aeb49896be93527286f83bd3635ec0cc7bbcd24f7"
        end
      end
    end
  end

  # Source definition
  head do
    url "https://github.com/elastic/harp.git", branch: "main"

    # build dependencies
    depends_on "go" => :build
    depends_on "mage" => :build
  end

  def install
    ENV.deparallelize

    if build.head?
      # Prepare build environment
      ENV["GOPATH"] = buildpath
      (buildpath/"src/github.com/elastic/harp").install Dir["{*,.git,.gitignore}"]

      # Mage tools
      ENV.prepend_path "PATH", buildpath/"tools/bin"

      # In github.com/elastic/harp command
      cd "src/github.com/elastic/harp/cmd/harp" do
        system "go", "mod", "vendor"
        system "mage", "compile"
      end

      # Install builded command
      cd "src/github.com/elastic/harp/cmd/harp/bin" do
        # Install binaries
        if OS.mac? && Hardware::CPU.arm?
          bin.install "harp-darwin-arm64" => "harp"
        elsif OS.mac?
          bin.install "harp-darwin-amd64" => "harp"
        elsif OS.linux?
          bin.install "harp-linux-amd64" => "harp"
        end
      end
    elsif OS.mac? && Hardware::CPU.arm?
      # Install binaries
      bin.install "harp-darwin-arm64" => "harp"
    elsif OS.mac?
      bin.install "harp-darwin-amd64" => "harp"
    elsif OS.linux?
      bin.install "harp-linux-amd64" => "harp"
    end

    # Final message
    ohai "Install success!"
  end

  def caveats
    <<~EOS
      If you have previously built harp from source, make sure you're not using
      $GOPATH/bin/harp instead of this one. If that's the case you can simply run
      rm -f $GOPATH/bin/harp
    EOS
  end

  test do
    assert_match version.to_s, shell_output("#{bin}/harp version")
  end
end
