# typed: false
# frozen_string_literal: true

# Code generated by Harp build tool
class Harp < Formula
  desc "Secret management toolchain"
  homepage "https://github.com/elastic/harp"
  version "0.2.10"
  license "Apache-2.0"

  on_macos do
    if Hardware::CPU.intel?
      url "https://github.com/elastic/harp/releases/download/v0.2.10/harp-darwin-amd64.tar.gz"
      sha256 "5af1ae8df4e7c96761d0fbd9b11743723528dffd8269738fd1c805da2fb349ca"
    elsif Hardware::CPU.arm?
      url "https://github.com/elastic/harp/releases/download/v0.2.10/harp-darwin-arm64.tar.gz"
      sha256 "5be453a93cad52ccf3033102c641b2bd6a63e5acc1d8dc539a77000504b92788"
    end
  end

  on_linux do
    if Hardware::CPU.intel?
      if Hardware::CPU.is_64_bit?
        url "https://github.com/elastic/harp/releases/download/v0.2.10/harp-linux-amd64.tar.gz"
        sha256 "5aea383faf537350f9d6a5785d9a4b56efb7974992a7fee4df52631292c8b2ed"
      end
    elsif Hardware::CPU.arm?
      if Hardware::CPU.is_64_bit?
        url "https://github.com/elastic/harp/releases/download/v0.2.10/harp-linux-arm64.tar.gz"
        sha256 "59fd71a419aeb334bc9fbc0e5315946defc3d3f8374538cbdffae3c32ff1c1b7"
      else
        url "https://github.com/elastic/harp/releases/download/v0.2.10/harp-linux-arm.tar.gz"
        sha256 "1429571d716b3f4dcf182b4f6f97393fd90b0f0b87910e31d3c316f563556605"
      end
    end
  end

  conflicts_with "harp-fips", because: "harp-fips also ships a 'harp' binary"

  def install
    ENV.deparallelize

    # Install binaries
    if OS.mac?
      if Hardware::CPU.arm?
        bin.install "harp-darwin-arm64" => "harp"
      else
        bin.install "harp-darwin-amd64" => "harp"
      end
    elsif OS.linux?
      if Hardware::CPU.arm?
        if Hardware::CPU.is_64_bit?
          bin.install "harp-linux-arm64" => "harp"
        else
          bin.install "harp-linux-arm" => "harp"
        end
      else
        if Hardware::CPU.is_64_bit?
          bin.install "harp-linux-amd64" => "harp"
        end
      end
    end

    # Exclude from Gatekeeper quarantine
    if MacOS.version >= :catalina && /com.apple.quarantine/.match?(Utils.safe_popen_read("xattr", "#{bin}/harp"))
      (bin/"harp").chmod 0755
      begin
        system "xattr", "-d",
                        "com.apple.quarantine",
                        bin/"harp"
      ensure
        (bin/"harp").chmod 0555
      end
    end

    # Final message
    ohai "Install success!"
  end

  def caveats
    <<~EOS
      If you have previously built harp from source, make sure you're not using
      $GOPATH/bin/harp instead of this one. If that's the case you can simply run
      rm -f $GOPATH/bin/harp
    EOS
  end

  test do
    assert_predicate bin/"harp", :exist?
    assert_match version.to_s, shell_output("#{bin}/harp version")
  end
end
