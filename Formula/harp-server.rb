# Code generated by Harp build tool
class HarpServer < Formula
  desc "Harp Crate Server"
  homepage "https://github.com/elastic/harp"
  license "Apache 2.0"
  bottle :unneeded

  # Stable build
  stable do
  	if OS.mac? && Hardware::CPU.arm?
	  url "https://github.com/elastic/harp/releases/download/cmd%2Fharp-server%2Fv0.1.12/harp-server-darwin-arm64-v0.1.12.tar.xz"
      sha256 "c9eea8a37a7a798eef2230252b09170f7e7c901615ed78e241dcabe70cbc36fa"
    elsif OS.mac?
      url "https://github.com/elastic/harp/releases/download/cmd%2Fharp-server%2Fv0.1.12/harp-server-darwin-amd64-v0.1.12.tar.xz"
      sha256 "736e19ac749e82bc2995993286435a331a721c3aec33676f3fe2091d63f66bb9"
    elsif OS.linux?
      url "https://github.com/elastic/harp/releases/download/cmd%2Fharp-server%2Fv0.1.12/harp-server-linux-amd64-v0.1.12.tar.xz"
      sha256 "4d2ee8fa2030d21b45d063ca7b68d895df86653bf1a68c56507f6a87a34078d0"
    end
  end

  # Source definition
  head do
    url "https://github.com/elastic/harp.git", :branch => "main"

    # build dependencies
    depends_on "go" => :build
    depends_on "mage" => :build
  end

  def install
    ENV.deparallelize

    unless build.head?
      # Install binaries
      if OS.mac? && Hardware::CPU.arm?
        bin.install "harp-server-darwin-arm64" => "harp-server"
      elsif OS.mac?
        bin.install "harp-server-darwin-amd64" => "harp-server"
      elsif OS.linux?
        bin.install "harp-server-linux-amd64" => "harp-server"
      end
    else
      # Prepare build environment
      ENV["GOPATH"] = buildpath
      (buildpath/"src/github.com/elastic/harp").install Dir["{*,.git,.gitignore}"]

      # Mage tools
      ENV.prepend_path "PATH", buildpath/"tools/bin"

      # In github.com/elastic/harp command
      cd "src/github.com/elastic/harp/cmd/harp-server" do
        system "go", "mod", "vendor"
        system "mage", "compile"
      end

      # Install builded command
      cd "src/github.com/elastic/harp/cmd/harp-server/bin" do
        # Install binaries
        if OS.mac? && Hardware::CPU.arm?
          bin.install "harp-server-darwin-arm64" => "harp-server"
        elsif OS.mac?
          bin.install "harp-server-darwin-amd64" => "harp-server"
        elsif OS.linux?
          bin.install "harp-server-linux-amd64" => "harp-server"
        end
      end
    end

    # Final message
    ohai "Install success!"
  end

  def caveats
    <<~EOS
      If you have previously built harp-server from source, make sure you're not using
      $GOPATH/bin/harp-server instead of this one. If that's the case you can simply run
      rm -f $GOPATH/bin/harp-server
    EOS
  end

  test do
    assert_match version.to_s, shell_output("#{bin}/harp-server version")
  end
end